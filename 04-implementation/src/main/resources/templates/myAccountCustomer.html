<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Account (Customer)</title>
    <link rel="stylesheet" th:href="@{/css/editAccount.css}">
</head>
<body>

<h1>My Account (Customer)</h1>

<form id="editForm">
    <label for="editUsername">Username</label>
    <input type="text" id="editUsername" name="username" th:value="${account.username}" required readonly><br>

    <label for="editEmail">Email</label>
    <input type="email" id="editEmail" name="email" th:value="${account.email}" required><br>

    <label for="editPassword">Password</label>
    <input type="password" id="editPassword" name="password" placeholder="Enter new password (Leave empty to keep the current password)"><br>

    <input type="hidden" id="accountId" th:value="${accountId}">
    <input type="hidden" id="role" name="role" th:value="${role}">

    <button type="submit">Save</button>
</form>

<a href="javascript:void(0)" class="btn cancel" onclick="goBack()">Back</a>

<script>
    // Ensure role and accountId are correctly passed from the backend
    const role = document.getElementById('role') ? document.getElementById('role').value : null;
    let accountId = document.getElementById('accountId') ? document.getElementById('accountId').value : null;
    accountId = Number(accountId);

    if (!role || !accountId || isNaN(accountId)) {
        console.error('Invalid role or accountId:', role, accountId);
        alert('Error: Missing role or accountId');
    }

    // Handle form submission to update account
    document.getElementById('editForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Gather form data
        const accountDTO = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            password: document.getElementById('editPassword').value.trim() === "" ? null : document.getElementById('editPassword').value
        };

        // If the role is "customer", we don't need to include phoneNumber, address, or companyName
        if (role === 'customer') {
            // Only include the customer-relevant fields
            accountDTO.phoneNumber = null;
            accountDTO.address = null;
            accountDTO.companyName = null;
        }

        // Send updated account data to the backend
        fetch(`/api/accounts/update/${role}/${accountId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountDTO)
        })
            .then(response => response.text())  // Get text response
            .then(text => {
                alert('Account updated successfully!');
                location.reload();  // Reload the page to reflect changes
            })
            .catch(error => {
                console.error('Error updating account:', error);
                alert('Error updating account. Please try again.');
            });
    });
    function goBack() {
        window.location.href = '/dashboard';
    }
</script>

</body>
</html>
