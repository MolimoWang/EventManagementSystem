<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Account</title>
    <link rel="stylesheet" th:href="@{/css/editAccount.css}">
</head>
<body>

<h1>My Account</h1>

<form id="editForm">
    <label for="editUsername">Username</label>
    <input type="text" id="editUsername" name="username" th:value="${account.username}" required readonly><br>

    <label for="editEmail">Email</label>
    <input type="email" id="editEmail" name="email" th:value="${account.email}" required><br>

    <label for="editPassword">Password</label>
    <input type="password" id="editPassword" name="password" placeholder="Enter new password (Leave empty to keep the current password)"><br>

    <label for="editPhoneNumber">Phone Number</label>
    <input type="text" id="editPhoneNumber" name="phoneNumber" th:value="${account.phoneNumber != null ? account.phoneNumber : ''}"><br>

    <label for="editAddress">Address</label>
    <input type="text" id="editAddress" name="address" th:value="${account.address != null ? account.address : ''}"><br>

    <label for="editCompanyName">Company Name</label>
    <input type="text" id="editCompanyName" name="companyName" th:value="${account.companyName != null ? account.companyName : ''}"><br>

    <!-- Pass the accountId here -->
    <input type="hidden" id="accountId" th:value="${accountId}"> <!-- accountId is passed separately -->
    <input type="hidden" id="role" name="role" th:value="${role}">

    <button type="submit">Save</button>
</form>

<a href="javascript:void(0)" class="btn cancel" onclick="goBack()">Back</a>

<script>
    function goBack() {
        window.location.href = '/dashboard';
    }
    // Ensure role and accountId are correctly passed from the backend
    const role = document.getElementById('role') ? document.getElementById('role').value : null;
    let accountId = document.getElementById('accountId') ? document.getElementById('accountId').value : null;
    accountId = Number(accountId);

    if (!role || !accountId || isNaN(accountId)) {
        console.error('Invalid role or accountId:', role, accountId);
        alert('Error: Missing role or accountId');
    }

    // Handle form submission to update account
    document.getElementById('editForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Gather form data
        const accountDTO = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            password: document.getElementById('editPassword').value.trim() === "" ? null : document.getElementById('editPassword').value,
            phoneNumber: document.getElementById('editPhoneNumber').value,
            address: document.getElementById('editAddress').value,
            companyName: document.getElementById('editCompanyName').value
        };
        console.log('Account ID from template:', accountId);
        console.log("Account DTO to be sent:", accountDTO);
        // Send updated account data to the backend
        fetch(`/api/accounts/update/${role}/${accountId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountDTO)
        })
            .then(response => {
                console.log("Response received:", response);

                // First, get the raw response as text
                return response.text();  // Get text response
            })
            .then(text => {
                try {
                    // Try parsing the response text as JSON
                    const json = JSON.parse(text);
                    console.log("Updated account:", json);

                    // If successful, display success message and reload page
                    alert('Account updated successfully!');
                    location.reload(); // Reload the page to reflect changes
                } catch (e) {
                    // If parsing fails, display the raw text response
                    console.error('Error parsing response:', e);
                    alert(text);  // Fallback: show the raw text response
                }
            })
            .catch(error => {
                console.error('Error updating account:', error);
                alert('Error updating account. Please try again.');
            });
    });
</script>

</body>
</html>
